{% extends "base.html" %}

{% block title %}
{{ title }}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Settings</h2>
    <div class="card sm-card">
        <div class="card-header">
            <h3>Profile Information</h3>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <label class="form-label">Choose a DiceBear Avatar:</label>
                <div class="row g-2 mb-3">
                    <div class="avatar-grid">
                    {% for i in range(1, 7) %}
                        {% set seed = current_user.username ~ i %}
                        {% set avatar_url = "https://api.dicebear.com/7.x/fun-emoji/svg?seed=" ~ seed %}
                        <div class="avatar-option" data-avatar-url="{{ avatar_url }}">
                            <img src="{{ avatar_url }}"
                                class="selectable-avatar img-thumbnail {% if avatar_url == current_user.get_avatar_url() %}border-primary{% endif %}"
                                onclick="selectAvatar('{{ avatar_url }}', this)"
                                width="100">
                            <div class="checkmark">âœ“</div>
                        </div>
                {% endfor %}
                    </div>
                </div>
                <input type="hidden" name="avatar_url" id="dicebear-url" value="{{ current_user.avatar_url or '' }}">
                        
               <p class="text-muted">Or upload your own image:</p>
                {{ form.avatar_upload.label }}
                {{ form.avatar_upload(class="form-control", onchange="previewUploadedImage(event)") }}

                <hr>
                <p><strong>Live Preview:</strong></p>
                {{ form.dicebear_url(id="avatar_seed", type="hidden") }}

                <img id="avatar-preview"
                    src="{{ current_user.get_avatar_url() or url_for('static', filename='default_avatar.svg') }}"
                    class="rounded mb-3"
                    width="120">


                {{ form.submit(class="btn btn-primary") }}
            </form>
        </div>
    </div>

    <div class="card sm-card">
        <div class="card-header">
            <h3>Change Display Name</h3>
        </div>
        <div class="card-body">
            <form method="post" autocomplete="off" action="{{ url_for('settings_bp.account_settings') }}">
                <div class="form-group mb-3">
                    {{ name_change_form.hidden_tag() }}
                    {{ name_change_form.new_name.label(class="form-label") }}
                    {{ name_change_form.new_name(class=['form-control', 'is-invalid' if name_change_form.new_name.errors else ''], placeholder="Enter New name") }}                    
                    {% if name_change_form.new_name.errors %}
                    <div class="invalid-feedback">
                        {% for error in name_change_form.new_name.errors %}
                        <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {{ name_change_form.submit(class="btn btn-primary")}}
                </div>
            </form>
        </div>
    </div>
    
    <div class="card sm-card">
        <div class="card-header">
            <h3>Change Password</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('settings_bp.account_settings') }}">
                {{ password_form.hidden_tag() if password_form else '' }}
                <div class="form-group mb-3">
                    {{ password_change_form.current_password.label(class="form-label") }}
                    {{ password_change_form.current_password(class=['form-control', 'is-invalid' if password_change_form.current_password.errors else ''], placeholder="Enter Old Password") }}
                    {% if password_change_form.current_password.errors %}
                    <div class="invalid-feedback">
                        {% for error in password_change_form.current_password.errors %}
                        <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group  mb-3">
                {{ password_change_form.new_password.label(class="form-label") }}
                {{ password_change_form.new_password(class=['form-control', 'is-invalid' if password_change_form.new_password.errors else ''], placeholder="Enter New password") }}
                {% if password_change_form.new_password.errors %}
                    <div class="invalid-feedback">
                        {% for error in password_change_form.new_password.errors %}
                        <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group mb-3">
                    {{ password_change_form.confirm_new_password.label(class="form-label") }}
                    {{ password_change_form.confirm_new_password(class=['form-control', 'is-invalid' if password_change_form.new_password.errors else ''], placeholder="Confirm New password") }}
                    {% if password_change_form.confirm_new_password.errors %}
                    <div class="invalid-feedback">
                        {% for error in password_change_form.confirm_new_password.errors %}
                        <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <button type="submit" 
                            name="action" 
                            value="change_password" 
                            class="button button-secondary">
                            Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card sm-card">
        <div class="card-header">
            <h3>Theme Settings</h3>
        </div>
        <div class="card-body d-flex justify-content-between align-items-center">
            <span class="fw-semibold">
                <i class="bi bi-moon-stars me-2"></i>Dark Mode
            </span>
            <div class="form-check form-switch">
                <input class="form-check-input" id="darkModeToggle" type="checkbox">
            </div>
        </div>
    </div>

    <div class="card sm-card">
        <button type="button" class="btn btn-warning"
            data-bs-toggle="modal"
            data-bs-target="#confirmModal"
            data-modal-title="Confirm Leave Household"
            data-modal-body="Are you sure you want to leave this household? If you are the admin and other members exist, admin rights will be transferred."
            data-modal-confirm-text="Yes, Leave"
            data-modal-confirm-class="btn-warning"
            data-action-url="{{ url_for('household_bp.leave') }}"
            data-redirect-url="{{ url_for('household_bp.setup') }}"> 
            Leave Household
        </button>
    </div>
</div>       
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/avatar_preview.js') }}"></script>
<script>
    function selectAvatar(url, element) {
    const preview = document.getElementById("avatar-preview");
    const dicebearInput = document.getElementById("dicebear-url");

    // Update live preview
    preview.src = url;

    // Set value in hidden input for backend
    dicebearInput.value = url;

    // Clear file upload field (only one allowed)
    const uploadInput = document.querySelector('input[type="file"]');
    if (uploadInput) uploadInput.value = '';

    // Visually highlight selection
    document.querySelectorAll('.selectable-avatar').forEach(img => {
      img.classList.remove('border-primary');
    });
    element.classList.add('border-primary');
  }

  function previewUploadedImage(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();

      reader.onload = function(e) {
        document.getElementById("avatar-preview").src = e.target.result;
      };
      reader.readAsDataURL(file);

      // Clear DiceBear selection
      document.getElementById("dicebear-url").value = '';

      // Remove highlighting from avatars
      document.querySelectorAll('.selectable-avatar').forEach(img => {
        img.classList.remove('border-primary');
      });
    }
  }
  function resetToDefaultAvatar() {
    const defaultUrl = "{{ 'https://api.dicebear.com/7.x/initials/svg?seed=' + current_user.username }}";
    document.getElementById('avatar_seed').value = defaultUrl;
    document.getElementById('avatar-preview').src = defaultUrl;
}
</script>
{% endblock %}